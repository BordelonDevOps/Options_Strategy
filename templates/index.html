<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Options Strategy Calculator - Professional Trading Analysis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --accent-gradient: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --warning-gradient: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            --danger-gradient: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            --dark-gradient: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            --light-bg: #f8fafc;
            --card-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            --hover-shadow: 0 20px 60px rgba(0, 0, 0, 0.12);
            --border-radius: 16px;
            --border-radius-lg: 24px;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            background: var(--primary-gradient);
            min-height: 100vh;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-weight: 400;
            line-height: 1.6;
            color: #2d3748;
            margin: 0;
            padding: 0;
        }
        
        .main-container {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            margin: 0;
            width: 100%;
            min-height: 100vh;
            overflow: hidden;
        }
        
        .header {
            background: var(--secondary-gradient);
            color: white;
            padding: 40px 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="1" fill="%23ffffff" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>') repeat;
            opacity: 0.3;
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }
        
        .header p {
            font-size: 1.1rem;
            font-weight: 300;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }
        .strategy-leg {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: var(--border-radius);
            padding: 24px;
            margin-bottom: 20px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.04);
            position: relative;
        }
        
        .strategy-leg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--secondary-gradient);
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .strategy-leg:hover {
            border-color: #4facfe;
            box-shadow: var(--card-shadow);
            transform: translateY(-2px);
        }
        
        .strategy-leg:hover::before {
            opacity: 1;
        }
        
        .btn-primary {
            background: var(--secondary-gradient);
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(79, 172, 254, 0.2);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.3);
            background: var(--secondary-gradient);
        }
        
        .btn-secondary {
            background: var(--primary-gradient);
            border: none;
            border-radius: 12px;
            padding: 10px 20px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-danger {
            background: var(--danger-gradient);
            border: none;
            border-radius: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-danger:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.3);
        }
        .form-control, .form-select {
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            padding: 12px 16px;
            font-size: 0.95rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: white;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
            outline: none;
        }
        
        .form-label {
            font-weight: 500;
            color: #4a5568;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        
        .card {
            border: none;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            box-shadow: var(--hover-shadow);
        }
        
        .card-header {
            background: var(--light-bg) !important;
            border-bottom: 1px solid #e2e8f0;
            border-radius: var(--border-radius) var(--border-radius) 0 0 !important;
            padding: 20px;
        }
        
        .card-body {
            padding: 24px;
        }
        
        .results-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 30px;
            margin-top: 24px;
            box-shadow: var(--card-shadow);
        }
        
        .metric-card {
            background: var(--primary-gradient);
            color: white;
            border-radius: var(--border-radius);
            padding: 24px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 100%);
            pointer-events: none;
        }
        
        .metric-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 12px 40px rgba(102, 126, 234, 0.3);
        }
        
        .metric-card h6 {
            font-weight: 500;
            opacity: 0.9;
            margin-bottom: 8px;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .metric-card h5 {
            font-weight: 700;
            font-size: 1.5rem;
            margin: 0;
        }
        
        .preset-btn {
            margin: 4px;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 0.85rem;
            font-weight: 500;
            border: 1px solid #e2e8f0;
            background: white;
            color: #4a5568;
            transition: all 0.2s ease;
        }
        
        .preset-btn:hover {
            background: var(--secondary-gradient);
            color: white;
            border-color: transparent;
            transform: translateY(-1px);
        }
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            margin: 30px 0;
        }
        
        .spinner-border {
            color: #4facfe;
            width: 3rem;
            height: 3rem;
            border-width: 0.3em;
        }
        
        .loading-text {
            margin-top: 16px;
            color: #6b7280;
            font-weight: 500;
        }
        
        #plotImage {
            max-width: 100%;
            height: auto;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
        }
        
        #plotImage:hover {
            box-shadow: var(--hover-shadow);
        }
        
        .alert {
            border-radius: var(--border-radius);
            border: none;
            padding: 16px 20px;
            font-weight: 500;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .alert-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
        
        .alert-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }
        
        .alert-info {
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 4px 12px rgba(79, 172, 254, 0.3);
        }
        .strategy-leg {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .strategy-leg:hover {
            border-color: #4facfe;
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.15);
            transform: translateY(-2px);
        }
        
        .strategy-leg h6 {
            color: #2d3748;
            font-weight: 600;
            margin-bottom: 16px;
            font-size: 1rem;
        }
        
        .strategy-leg .form-label {
            font-weight: 500;
            color: #4a5568;
            margin-bottom: 6px;
            font-size: 0.9rem;
        }
        
        .strategy-leg .form-control,
        .strategy-leg .form-select {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        
        .strategy-leg .form-control:focus,
        .strategy-leg .form-select:focus {
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }
        
        .strategy-leg .row {
            margin-bottom: 12px;
        }
        
        .strategy-leg .row:last-child {
            margin-bottom: 0;
        }
        
        .col-md-2-2-5 {
            flex: 0 0 auto;
            width: 20.83%;
        }
        
        .col-md-1-5 {
            flex: 0 0 auto;
            width: 12.5%;
        }
        .strategy-leg .form-control:focus,
        .strategy-leg .form-select:focus {
            border-color: #4facfe;
            box-shadow: 0 0 0 0.2rem rgba(79, 172, 254, 0.25);
        }
    </style>
</head>
<body>
    <div class="container-fluid px-0">
        <div class="main-container">
            <div class="header">
                <h1><i class="fas fa-chart-line"></i> Options Strategy Calculator</h1>
                <p class="mb-0">Professional Trading Analysis & Risk Management Platform</p>
            </div>
            
            <div class="row g-0">
                <!-- Input Panel -->
                <div class="col-lg-4">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-header bg-light">
                            <h5 class="mb-0"><i class="fas fa-cog"></i> Strategy Configuration</h5>
                        </div>
                        <div class="card-body" style="overflow-y: auto;">
                            <!-- Preset Strategies -->
                            <div class="mb-4">
                                <label class="form-label fw-bold">Quick Presets:</label>
                                <div>
                                    <button class="btn btn-outline-primary preset-btn" onclick="loadPreset('covered_call')">Covered Call</button>
                                    <button class="btn btn-outline-primary preset-btn" onclick="loadPreset('protective_put')">Protective Put</button>
                                    <button class="btn btn-outline-primary preset-btn" onclick="loadPreset('bull_call_spread')">Bull Call Spread</button>
                                    <button class="btn btn-outline-primary preset-btn" onclick="loadPreset('bear_put_spread')">Bear Put Spread</button>
                                    <button class="btn btn-outline-primary preset-btn" onclick="loadPreset('iron_condor')">Iron Condor</button>
                                    <button class="btn btn-outline-primary preset-btn" onclick="loadPreset('straddle')">Long Straddle</button>
                                </div>
                            </div>

                            <form id="strategyForm">
                                <!-- Step 1: Stock Lookup -->
                                <div class="mb-4">
                                    <label class="form-label fw-bold"><i class="fas fa-search"></i> Step 1: Stock Lookup</label>
                                    <div class="row mb-2">
                                        <div class="col-12">
                                            <label class="form-label">Stock Ticker</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control" id="stockTicker" placeholder="e.g., AAPL, MSFT, TSLA" value="" style="text-transform: uppercase;">
                                                <button class="btn btn-primary" type="button" onclick="searchStock()">
                                                    <i class="fas fa-search"></i> Lookup Stock
                                                </button>
                                            </div>
                                            <small class="text-muted">Enter stock symbol to get current price, volatility, and options data</small>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-6">
                                            <label class="form-label">Stock Price ($)</label>
                                            <input type="number" class="form-control" id="stockPrice" value="" step="0.01" required readonly>
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label">Volatility</label>
                                            <input type="number" class="form-control" id="volatility" value="" step="0.001" required readonly>
                                        </div>
                                    </div>
                                </div>

                                <!-- Step 2: Options Data -->
                                <div class="mb-4" id="optionsSection" style="display: none;">
                                    <label class="form-label fw-bold"><i class="fas fa-chart-line"></i> Step 2: Options Data</label>
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <span class="text-muted">Available options for <span id="optionsTicker"></span></span>
                                        <button class="btn btn-outline-primary btn-sm" type="button" onclick="loadOptionsData()">
                                            <i class="fas fa-sync-alt"></i> Load Options
                                        </button>
                                    </div>
                                    <div id="optionsData" class="border rounded p-3" style="max-height: 300px; overflow-y: auto; background: #f8f9fa;">
                                        <div class="text-center text-muted">
                                            <i class="fas fa-info-circle"></i> Click "Load Options" to view available strikes and premiums
                                        </div>
                                    </div>
                                </div>

                                <!-- Dates -->
                                <div class="mb-3">
                                    <div class="row">
                                        <div class="col-6">
                                            <label class="form-label">Start Date</label>
                                            <input type="date" class="form-control" id="startDate" required>
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label">Target Date</label>
                                            <input type="date" class="form-control" id="targetDate" required>
                                        </div>
                                    </div>
                                </div>

                                <!-- Optional Parameters -->
                                <div class="mb-3">
                                    <div class="row">
                                        <div class="col-4">
                                            <label class="form-label">Interest Rate (%)</label>
                                            <input type="number" class="form-control" id="interestRate" value="5.25" step="0.01" placeholder="e.g., 5.25" title="Use current Fed funds rate or 10-year Treasury rate. Most brokers don't display this - check FRED, Yahoo Finance, or use ~5% as approximation">
                                            <small class="text-muted">Fed funds rate (~5%) - not shown on most brokers</small>
                                        </div>
                                        <div class="col-4">
                                            <label class="form-label">Profit Target ($)</label>
                                            <input type="number" class="form-control" id="profitTarget" step="0.01">
                                        </div>
                                        <div class="col-4">
                                            <label class="form-label">Loss Limit ($)</label>
                                            <input type="number" class="form-control" id="lossLimit" step="0.01">
                                        </div>
                                    </div>
                                </div>

                                <!-- Step 3: Strategy Legs -->
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <label class="form-label fw-bold">Step 3: Strategy Legs</label>
                                        <button type="button" class="btn btn-secondary btn-sm" onclick="addStrategyLeg()">
                                            <i class="fas fa-plus"></i> Add Leg
                                        </button>
                                    </div>
                                    <div id="strategyLegs">
                                        <!-- Strategy legs will be added here -->
                                    </div>
                                </div>

                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-calculator"></i> Calculate Strategy
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Chart Panel -->
                <div class="col-lg-8">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-header bg-light">
                            <h5 class="mb-0"><i class="fas fa-chart-area"></i> Strategy Visualization</h5>
                        </div>
                        <div class="card-body d-flex flex-column" style="padding: 15px;">
                            <div id="loading" class="loading text-center flex-grow-1 d-flex align-items-center justify-content-center">
                                <div>
                                    <div class="spinner-border mb-3" role="status" style="width: 3rem; height: 3rem;">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="h5">Calculating strategy...</p>
                                </div>
                            </div>

                            <div id="chartPlaceholder" class="text-center d-flex align-items-center justify-content-center" style="min-height: 250px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border-radius: 10px; border: 2px dashed #dee2e6;">
                                <div>
                                    <i class="fas fa-chart-line" style="font-size: 4rem; color: #6c757d; margin-bottom: 1rem;"></i>
                                    <h4 class="text-muted">Strategy Chart</h4>
                                    <p class="text-muted">Configure your strategy and click "Calculate" to see the profit/loss diagram</p>
                                </div>
                            </div>

                            <div id="results" style="display: none;" class="flex-grow-1">
                                <!-- Charts Display -->
                                <div class="row mb-4">
                                    <!-- Stock Price Chart -->
                                    <div class="col-md-6">
                                        <div class="text-center">
                                            <h5 class="mb-3"><i class="fas fa-chart-line"></i> Stock Price Chart</h5>
                                            <div id="stockChartContainer" style="display: none;">
                                                <img id="stockChart" src="" alt="Stock Price Chart" style="max-width: 100%; height: auto; max-height: 400px; border-radius: 10px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);">
                                            </div>
                                            <div id="stockChartPlaceholder" class="d-flex align-items-center justify-content-center" style="height: 300px; background: #f8f9fa; border-radius: 10px; border: 2px dashed #dee2e6;">
                                                <div class="text-center">
                                                    <i class="fas fa-chart-area" style="font-size: 2rem; color: #6c757d; margin-bottom: 0.5rem;"></i>
                                                    <p class="text-muted mb-0">Stock chart will appear here</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Strategy P&L Chart -->
                                    <div class="col-md-6">
                                        <div class="text-center">
                                            <h5 class="mb-3"><i class="fas fa-chart-bar"></i> Strategy P&L Chart</h5>
                                            <img id="plotImage" src="" alt="P&L Diagram" style="max-width: 100%; height: auto; max-height: 400px; border-radius: 10px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Key Metrics Row -->
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <div class="metric-card" style="padding: 15px;">
                                            <h6 class="mb-1">Probability of Profit</h6>
                                            <h5 id="popMetric" class="mb-0">-</h5>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="metric-card" style="padding: 15px;">
                                            <h6 class="mb-1">Max Profit</h6>
                                            <h5 id="maxProfitMetric" class="mb-0">-</h5>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="metric-card" style="padding: 15px;">
                                            <h6 class="mb-1">Max Loss</h6>
                                            <h5 id="maxLossMetric" class="mb-0">-</h5>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="metric-card" style="padding: 15px;">
                                            <h6 class="mb-1">Strategy Cost</h6>
                                            <h5 id="strategyCostMetric" class="mb-0">-</h5>
                                        </div>
                                    </div>
                                </div>

                                <!-- Additional Metrics -->
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-1"><strong>Breakeven Points:</strong> <span id="breakevenPoints">-</span></p>
                                        <p class="mb-1"><strong>Expected Profit:</strong> <span id="expectedProfit">-</span></p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-1"><strong>Expected Loss:</strong> <span id="expectedLoss">-</span></p>
                                        <p class="mb-1"><strong>Profit Ranges:</strong> <span id="profitRanges">-</span></p>
                                    </div>
                                </div>
                            </div>

                            <div id="error" class="alert alert-danger" style="display: none;">
                                <h5><i class="fas fa-exclamation-triangle"></i> Error</h5>
                                <p id="errorMessage"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let legCounter = 0;

        // Initialize dates
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, today.getDate());
            
            document.getElementById('startDate').value = today.toISOString().split('T')[0];
            document.getElementById('targetDate').value = nextMonth.toISOString().split('T')[0];
            
            // Add initial strategy leg
            addStrategyLeg();
        });

        function addStrategyLeg() {
            const container = document.getElementById('strategyLegs');
            const legId = `leg_${legCounter++}`;
            
            const legHtml = `
                <div class="strategy-leg" id="${legId}">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">Leg ${legCounter}</h6>
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeStrategyLeg('${legId}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="row">
                        <div class="col-md-2-2-5">
                            <label class="form-label">Type</label>
                            <select class="form-select" name="type" onchange="toggleLegFields(this)">
                                <option value="call">Call</option>
                                <option value="put">Put</option>
                                <option value="stock">Stock</option>
                            </select>
                        </div>
                        <div class="col-md-2-2-5">
                                            <label class="form-label">Action</label>
                                            <select class="form-select" name="action">
                                                <option value="buy">Buy</option>
                                                <option value="sell">Sell</option>
                                            </select>
                                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Qty</label>
                            <input type="number" class="form-control" name="n" value="1" min="1" max="99" required>
                        </div>
                        <div class="col-md-2 option-field">
                            <label class="form-label">Strike</label>
                            <input type="number" class="form-control" name="strike" step="0.01">
                        </div>
                        <div class="col-md-2 option-field">
                            <label class="form-label">Premium</label>
                            <input type="number" class="form-control" name="premium" step="0.01">
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', legHtml);
        }

        function removeStrategyLeg(legId) {
            document.getElementById(legId).remove();
        }

        function toggleLegFields(selectElement) {
            const leg = selectElement.closest('.strategy-leg');
            const optionFields = leg.querySelectorAll('.option-field');
            const isOption = selectElement.value === 'call' || selectElement.value === 'put';
            
            optionFields.forEach(field => {
                field.style.display = isOption ? 'block' : 'none';
                const inputs = field.querySelectorAll('input');
                inputs.forEach(input => {
                    input.required = isOption;
                });
            });
        }

        async function loadPreset(presetName) {
            try {
                const response = await fetch(`/preset/${presetName}`);
                const preset = await response.json();
                
                // Clear existing legs
                document.getElementById('strategyLegs').innerHTML = '';
                legCounter = 0;
                
                // Add preset legs
                preset.strategy.forEach(leg => {
                    addStrategyLeg();
                    const lastLeg = document.querySelector('#strategyLegs .strategy-leg:last-child');
                    
                    lastLeg.querySelector('[name="type"]').value = leg.type;
                    lastLeg.querySelector('[name="action"]').value = leg.action;
                    lastLeg.querySelector('[name="n"]').value = leg.n;
                    
                    if (leg.strike) {
                        lastLeg.querySelector('[name="strike"]').value = leg.strike;
                    }
                    if (leg.premium) {
                        lastLeg.querySelector('[name="premium"]').value = leg.premium;
                    }
                    
                    // Toggle fields based on type
                    toggleLegFields(lastLeg.querySelector('[name="type"]'));
                });
                
            } catch (error) {
                console.error('Error loading preset:', error);
            }
        }

        async function searchStock() {
            const ticker = document.getElementById('stockTicker').value.toUpperCase();
            if (!ticker) {
                alert('Please enter a stock ticker symbol');
                return;
            }
            
            // Show loading state
            const button = event.target.closest('button');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Looking up...';
            button.disabled = true;
            
            try {
                // Call the yfinance API endpoint
                const response = await fetch(`/api/stock/${ticker}`);
                const result = await response.json();
                
                if (result.success) {
                    // Update form fields with real data
                    document.getElementById('stockPrice').value = result.data.current_price;
                    document.getElementById('volatility').value = result.data.volatility;
                    
                    // Show success message with company info
                    const tickerInput = document.getElementById('stockTicker');
                    tickerInput.style.borderColor = '#28a745';
                    tickerInput.title = `${result.data.company_name} - ${result.data.sector}`;
                    
                    // Show Step 2: Options Section
                    document.getElementById('optionsSection').style.display = 'block';
                    const tickerElement = document.getElementById('optionsTicker');
                if (tickerElement) tickerElement.textContent = result.data.ticker;
                    
                    // Fetch and display stock chart
                    await loadStockChart(ticker);
                    
                    // Reset options data
                    document.getElementById('optionsData').innerHTML = `
                        <div class="text-center text-muted">
                            <i class="fas fa-info-circle"></i> Click "Load Options" to view available strikes and premiums for ${result.data.ticker}
                        </div>
                    `;
                    
                    // Show success notification
                    showNotification(
                        `✅ ${result.data.company_name} (${result.data.ticker})`,
                        `Price: $${result.data.current_price} | Volatility: ${(result.data.volatility * 100).toFixed(1)}% | Ready for options lookup`,
                        'success'
                    );
                    
                    setTimeout(() => {
                        tickerInput.style.borderColor = '';
                    }, 3000);
                } else {
                    // Handle API error
                    document.getElementById('stockPrice').value = 100.00;
                    document.getElementById('volatility').value = 0.300;
                    
                    // Hide options section on error
                    document.getElementById('optionsSection').style.display = 'none';
                    
                    // Hide stock chart on error
                    document.getElementById('stockChartContainer').style.display = 'none';
                    document.getElementById('stockChartPlaceholder').style.display = 'flex';
                    
                    const tickerInput = document.getElementById('stockTicker');
                    tickerInput.style.borderColor = '#dc3545';
                    
                    showNotification(
                        `❌ Error fetching ${ticker}`,
                        result.error || 'Stock not found. Using default values.',
                        'error'
                    );
                    
                    setTimeout(() => {
                        tickerInput.style.borderColor = '';
                    }, 3000);
                }
            } catch (error) {
                // Handle network error
                document.getElementById('stockPrice').value = 100.00;
                document.getElementById('volatility').value = 0.300;
                
                // Hide options section on error
                document.getElementById('optionsSection').style.display = 'none';
                
                // Hide stock chart on error
                document.getElementById('stockChartContainer').style.display = 'none';
                document.getElementById('stockChartPlaceholder').style.display = 'flex';
                
                const tickerInput = document.getElementById('stockTicker');
                tickerInput.style.borderColor = '#dc3545';
                
                showNotification(
                    `❌ Network Error`,
                    `Failed to fetch data for ${ticker}. Using default values.`,
                    'error'
                );
                
                setTimeout(() => {
                    tickerInput.style.borderColor = '';
                }, 3000);
            } finally {
                // Reset button
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }
        
        async function loadStockChart(ticker) {
            try {
                // Fetch stock chart data
                const response = await fetch(`/api/stock/${ticker}/chart?period=3mo`);
                const result = await response.json();
                
                if (result.success) {
                    // Show the stock chart
                    document.getElementById('stockChart').src = `data:image/png;base64,${result.chart}`;
                    document.getElementById('stockChartContainer').style.display = 'block';
                    document.getElementById('stockChartPlaceholder').style.display = 'none';
                } else {
                    console.error('Failed to load stock chart:', result.error);
                    // Keep placeholder visible on error
                    document.getElementById('stockChartContainer').style.display = 'none';
                    document.getElementById('stockChartPlaceholder').style.display = 'flex';
                }
            } catch (error) {
                console.error('Error loading stock chart:', error);
                // Keep placeholder visible on error
                document.getElementById('stockChartContainer').style.display = 'none';
                document.getElementById('stockChartPlaceholder').style.display = 'flex';
            }
        }
        
        function showNotification(title, message, type) {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
            notification.innerHTML = `
                <strong>${title}</strong><br>
                <small>${message}</small>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }
        
        async function loadOptionsData() {
            const ticker = document.getElementById('stockTicker').value.toUpperCase();
            if (!ticker) {
                alert('Please lookup a stock first');
                return;
            }
            
            // Show loading state
            const button = event.target.closest('button');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            button.disabled = true;
            
            const optionsContainer = document.getElementById('optionsData');
            optionsContainer.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading options data...</div>';
            
            try {
                const response = await fetch(`/api/options/${ticker}`);
                const result = await response.json();
                
                if (result.success && result.data.expirations && result.data.expirations.length > 0) {
                    let optionsHtml = '';
                    
                    result.data.expirations.forEach((expiration, index) => {
                        if (index < 3) { // Show first 3 expiration dates
                            optionsHtml += `
                                <div class="mb-3">
                                    <h6 class="fw-bold text-primary">Expiration: ${expiration.expiration}</h6>
                                    <div class="row">
                                        <div class="col-6">
                                            <h6 class="text-success">Calls</h6>
                                            <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                                                <table class="table table-sm table-hover">
                                                    <thead class="table-light">
                                                        <tr><th>Strike</th><th>Last</th><th>Bid</th><th>Ask</th><th>Vol</th></tr>
                                                    </thead>
                                                    <tbody>`;
                            
                            // Show calls near current price
                            const currentPrice = result.data.current_price;
                            const relevantCalls = expiration.calls.filter(call => 
                                call.strike >= currentPrice * 0.8 && call.strike <= currentPrice * 1.2
                            ).slice(0, 8);
                            
                            relevantCalls.forEach(call => {
                                const isNearMoney = Math.abs(call.strike - currentPrice) < currentPrice * 0.05;
                                optionsHtml += `
                                    <tr class="${isNearMoney ? 'table-warning' : ''}" style="cursor: pointer;" 
                                        onclick="selectOption('call', ${call.strike}, ${call.lastPrice || (call.bid + call.ask) / 2}, '${expiration.expiration}')">
                                        <td>$${call.strike}</td>
                                        <td>$${call.lastPrice.toFixed(2)}</td>
                                        <td>$${call.bid.toFixed(2)}</td>
                                        <td>$${call.ask.toFixed(2)}</td>
                                        <td>${call.volume}</td>
                                    </tr>`;
                            });
                            
                            optionsHtml += `
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <h6 class="text-danger">Puts</h6>
                                            <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                                                <table class="table table-sm table-hover">
                                                    <thead class="table-light">
                                                        <tr><th>Strike</th><th>Last</th><th>Bid</th><th>Ask</th><th>Vol</th></tr>
                                                    </thead>
                                                    <tbody>`;
                            
                            // Show puts near current price
                            const relevantPuts = expiration.puts.filter(put => 
                                put.strike >= currentPrice * 0.8 && put.strike <= currentPrice * 1.2
                            ).slice(0, 8);
                            
                            relevantPuts.forEach(put => {
                                const isNearMoney = Math.abs(put.strike - currentPrice) < currentPrice * 0.05;
                                optionsHtml += `
                                    <tr class="${isNearMoney ? 'table-warning' : ''}" style="cursor: pointer;" 
                                        onclick="selectOption('put', ${put.strike}, ${put.lastPrice || (put.bid + put.ask) / 2}, '${expiration.expiration}')">
                                        <td>$${put.strike}</td>
                                        <td>$${put.lastPrice.toFixed(2)}</td>
                                        <td>$${put.bid.toFixed(2)}</td>
                                        <td>$${put.ask.toFixed(2)}</td>
                                        <td>${put.volume}</td>
                                    </tr>`;
                            });
                            
                            optionsHtml += `
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>`;
                        }
                    });
                    
                    optionsHtml += `
                        <div class="alert alert-info mt-3">
                            <small><i class="fas fa-info-circle"></i> 
                            Click on any option to add it to your strategy. Yellow rows are near-the-money options.
                            Current stock price: $${result.data.current_price}
                            </small>
                        </div>`;
                    
                    optionsContainer.innerHTML = optionsHtml;
                    
                    showNotification(
                        `✅ Options loaded for ${ticker}`,
                        `Found ${result.data.expirations ? result.data.expirations.length : 0} expiration dates. Click options to add to strategy.`,
                        'success'
                    );
                    
                } else {
                    optionsContainer.innerHTML = `
                        <div class="text-center text-muted">
                            <i class="fas fa-exclamation-triangle"></i> No options data available for ${ticker}
                        </div>`;
                    
                    showNotification(
                        `❌ No options found`,
                        `No options data available for ${ticker}. You can still manually enter option details.`,
                        'error'
                    );
                }
                
            } catch (error) {
                optionsContainer.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="fas fa-exclamation-triangle"></i> Error loading options data
                    </div>`;
                
                showNotification(
                    `❌ Error loading options`,
                    `Failed to load options for ${ticker}. You can still manually enter option details.`,
                    'error'
                );
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }
        
        function selectOption(type, strike, premium, expiration) {
            // Check if there's an existing leg that's empty (no type selected)
            const existingLegs = document.querySelectorAll('#strategyLegs .strategy-leg');
            let targetLeg = null;
            
            // Look for the first empty leg (where type is not selected)
            for (let leg of existingLegs) {
                const typeSelect = leg.querySelector('[name="type"]');
                if (typeSelect && typeSelect.value === '') {
                    targetLeg = leg;
                    break;
                }
            }
            
            // If no empty leg found, create a new one
            if (!targetLeg) {
                addStrategyLeg();
                targetLeg = document.querySelector('#strategyLegs .strategy-leg:last-child');
            }
            
            // Fill in the option details
            targetLeg.querySelector('[name="type"]').value = type;
            targetLeg.querySelector('[name="action"]').value = 'buy'; // Automatically set to 'buy' when selecting from options chain
            targetLeg.querySelector('[name="strike"]').value = strike;
            targetLeg.querySelector('[name="premium"]').value = premium.toFixed(2);
            
            // Toggle fields to show option-specific inputs
            toggleLegFields(targetLeg.querySelector('[name="type"]'));
            
            // Show success message
            showNotification(
                `✅ Option added`,
                `BUY ${type.toUpperCase()} $${strike} @ $${premium.toFixed(2)} (${expiration})`,
                'success'
            );
            
            // Scroll to the strategy legs section
            document.getElementById('strategyLegs').scrollIntoView({ behavior: 'smooth' });
        }
        
        // Auto-lookup on Enter key
        document.getElementById('stockTicker').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                searchStock();
            }
        });
        
        // Auto-uppercase ticker input
        document.getElementById('stockTicker').addEventListener('input', function(e) {
            e.target.value = e.target.value.toUpperCase();
        });

        document.getElementById('strategyForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Show loading
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('chartPlaceholder').style.display = 'none';
            document.getElementById('results').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            
            // Collect and validate form data
            const stockTicker = document.getElementById('stockTicker').value.toUpperCase().trim();
            const stockPriceValue = document.getElementById('stockPrice').value;
            const volatilityValue = document.getElementById('volatility').value;
            const interestRateValue = document.getElementById('interestRate').value;
            
            // Validate required fields
            if (!stockTicker) {
                throw new Error('Stock ticker is required');
            }
            if (!stockPriceValue || stockPriceValue.trim() === '') {
                throw new Error('Stock price is required');
            }
            if (!volatilityValue || volatilityValue.trim() === '') {
                throw new Error('Volatility is required');
            }
            if (!interestRateValue || interestRateValue.trim() === '') {
                throw new Error('Interest rate is required');
            }
            
            const stockPrice = parseFloat(stockPriceValue);
            const volatility = parseFloat(volatilityValue);
            const interestRate = parseFloat(interestRateValue);
            
            // Validate parsed numbers
            if (isNaN(stockPrice) || stockPrice <= 0) {
                throw new Error('Stock price must be a positive number');
            }
            if (isNaN(volatility) || volatility < 0) {
                throw new Error('Volatility must be a non-negative number');
            }
            if (isNaN(interestRate)) {
                throw new Error('Interest rate must be a valid number');
            }
            
            const formData = {
                stock_ticker: stockTicker,
                stock_price: stockPrice,
                volatility: volatility,
                start_date: document.getElementById('startDate').value,
                target_date: document.getElementById('targetDate').value,
                interest_rate: interestRate,
                profit_target: (() => {
                    const value = document.getElementById('profitTarget').value;
                    if (!value || value.trim() === '') return null;
                    const parsed = parseFloat(value);
                    if (isNaN(parsed)) throw new Error('Profit target must be a valid number');
                    return parsed;
                })(),
                loss_limit: (() => {
                    const value = document.getElementById('lossLimit').value;
                    if (!value || value.trim() === '') return null;
                    const parsed = parseFloat(value);
                    if (isNaN(parsed)) throw new Error('Loss limit must be a valid number');
                    return parsed;
                })(),
                strategy: []
            };
            
            // Collect strategy legs
            const legs = document.querySelectorAll('.strategy-leg');
            
            // Validate that at least one strategy leg exists
            if (legs.length === 0) {
                // Hide loading and show error
                document.getElementById('loading').style.display = 'none';
                document.getElementById('chartPlaceholder').style.display = 'block';
                document.getElementById('results').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                const errorElement = document.getElementById('errorMessage');
                    if (errorElement) errorElement.textContent = 'Please add at least one strategy leg before calculating.';
                
                showNotification(
                    '⚠️ Missing Strategy Legs',
                    'Please add at least one strategy leg using the "Add Leg" button.',
                    'warning'
                );
                return;
            }
            
            legs.forEach(leg => {
                const type = leg.querySelector('[name="type"]').value;
                const qtyValue = leg.querySelector('[name="n"]').value;
                
                // Validate quantity
                if (!qtyValue || qtyValue.trim() === '') {
                    throw new Error('Quantity is required for all strategy legs');
                }
                const quantity = parseInt(qtyValue);
                if (isNaN(quantity) || quantity <= 0) {
                    throw new Error('Quantity must be a positive integer');
                }
                
                const legData = {
                    type: type,
                    action: leg.querySelector('[name="action"]').value,
                    n: quantity
                };
                
                if (type === 'call' || type === 'put') {
                    const strikeValue = leg.querySelector('[name="strike"]').value;
                    const premiumValue = leg.querySelector('[name="premium"]').value;
                    
                    // Validate that strike and premium are not empty
                    if (!strikeValue || strikeValue.trim() === '') {
                        throw new Error('Strike price is required for options');
                    }
                    if (!premiumValue || premiumValue.trim() === '') {
                        throw new Error('Premium is required for options');
                    }
                    
                    legData.strike = parseFloat(strikeValue);
                    legData.premium = parseFloat(premiumValue);
                    
                    // Additional validation for valid numbers
                    if (isNaN(legData.strike) || legData.strike <= 0) {
                        throw new Error('Strike price must be a positive number');
                    }
                    if (isNaN(legData.premium) || legData.premium < 0) {
                        throw new Error('Premium must be a non-negative number');
                    }
                }
                
                formData.strategy.push(legData);
            });
            
            try {
                // Add timeout to prevent hanging
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
                
                const response = await fetch('/calculate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                const result = await response.json();
                
                if (result.success) {
                    // Update metrics with null checks
                    const popElement = document.getElementById('popMetric');
                    if (popElement) popElement.textContent = result.metrics.probability_of_profit ? `${result.metrics.probability_of_profit}%` : 'N/A';
                    
                    const maxProfitElement = document.getElementById('maxProfitMetric');
                    if (maxProfitElement) maxProfitElement.textContent = result.metrics.max_profit ? `$${result.metrics.max_profit}` : 'Unlimited';
                    
                    const maxLossElement = document.getElementById('maxLossMetric');
                    if (maxLossElement) maxLossElement.textContent = result.metrics.max_loss ? `$${result.metrics.max_loss}` : 'Unlimited';
                    
                    const strategyCostElement = document.getElementById('strategyCostMetric');
                    if (strategyCostElement) strategyCostElement.textContent = result.metrics.strategy_cost ? `$${result.metrics.strategy_cost}` : 'N/A';
                    
                    // Update additional metrics with null checks
                    const breakevenElement = document.getElementById('breakevenPoints');
                    if (breakevenElement) breakevenElement.textContent = result.metrics.breakeven_points && result.metrics.breakeven_points.length > 0 ? result.metrics.breakeven_points.map(bp => `$${bp}`).join(', ') : 'None';
                    
                    const expectedProfitElement = document.getElementById('expectedProfit');
                    if (expectedProfitElement) expectedProfitElement.textContent = result.metrics.expected_profit ? `$${result.metrics.expected_profit}` : 'N/A';
                    
                    const expectedLossElement = document.getElementById('expectedLoss');
                    if (expectedLossElement) expectedLossElement.textContent = result.metrics.expected_loss ? `$${result.metrics.expected_loss}` : 'N/A';
                    
                    const profitRangesElement = document.getElementById('profitRanges');
                    if (profitRangesElement) profitRangesElement.textContent = result.metrics.profit_ranges && result.metrics.profit_ranges.length > 0 ? result.metrics.profit_ranges.map(range => `$${range[0]} - $${range[1]}`).join(', ') : 'None';
                    
                    // Update plot
                    document.getElementById('plotImage').src = `data:image/png;base64,${result.plot}`;
                    
                    // Show results
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('chartPlaceholder').style.display = 'none';
                    document.getElementById('results').style.display = 'block';
                    document.getElementById('error').style.display = 'none';
                    
                    showNotification(
                        '✅ Strategy Calculated',
                        'Your options strategy has been successfully analyzed.',
                        'success'
                    );
                } else {
                    const errorElement = document.getElementById('errorMessage');
                    if (errorElement) errorElement.textContent = result.error;
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('chartPlaceholder').style.display = 'flex';
                    document.getElementById('results').style.display = 'none';
                    document.getElementById('error').style.display = 'block';
                    
                    showNotification(
                        '❌ Calculation Error',
                        result.error || 'An error occurred during calculation.',
                        'error'
                    );
                }
            } catch (error) {
                let errorMessage = 'Network error occurred';
                let notificationTitle = '❌ Network Error';
                
                if (error.name === 'AbortError') {
                    errorMessage = 'Calculation timed out after 30 seconds. Please try again with a simpler strategy.';
                    notificationTitle = '⏱️ Timeout Error';
                } else if (error.message && (error.message.includes('Strike price') || error.message.includes('Premium') || error.message.includes('required') || error.message.includes('positive number') || error.message.includes('non-negative'))) {
                    // Handle validation errors
                    errorMessage = error.message;
                    notificationTitle = '⚠️ Validation Error';
                } else {
                    errorMessage = `Network error: ${error.message}`;
                }
                
                const errorElement = document.getElementById('errorMessage');
                if (errorElement) errorElement.textContent = errorMessage;
                document.getElementById('loading').style.display = 'none';
                document.getElementById('chartPlaceholder').style.display = 'flex';
                document.getElementById('results').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                
                showNotification(
                    notificationTitle,
                    errorMessage,
                    'error'
                );
            }
        });
    </script>
</body>
</html>